package sdiag.main.web;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.catalina.util.StringParser;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;

import com.google.gson.Gson;

import egovframework.rte.fdl.security.userdetails.util.EgovUserDetailsHelper;
import egovframework.rte.psl.dataaccess.util.EgovMap;
import sdiag.board.service.NoticeService;
import sdiag.board.service.NoticeVO;
import sdiag.com.service.CodeInfoVO;
import sdiag.com.service.CommonService;
import sdiag.dash.service.GaugeItemValue;
import sdiag.getdata.service.GetDataService;
import sdiag.main.service.UserMainIdxInfoVO;
import sdiag.main.service.UserMainService;
import sdiag.main.service.UserPolIdxInfoVO;
import sdiag.man.service.SearchVO;
import sdiag.man.service.SecPolService;
import sdiag.member.service.MemberVO;
import sdiag.pol.service.PolicyService;
import sdiag.pol.service.UserIdxinfoVO;
import sdiag.pol.web.PolicyController;
import sdiag.util.CommonUtil;
import sdiag.util.HTMLInputFilter;

@Controller
public class UserMainController {
	@Resource(name = "UserMainService")
	protected UserMainService userMainService;
	
	@Resource(name = "commonService")
	protected CommonService comService;
	
	@Resource(name = "PolicyService")
	private PolicyService polService;
	
	@Resource(name = "GetDataService")
	private GetDataService getDataService;
	
	@Resource(name = "SecPolService")
	private SecPolService secPolService;
	
	
	
	/**
	 * 메인화면 class
	 * @throws Exception 
	 */
	@RequestMapping("/main/userMain.do")
	private String userMain(HttpServletRequest request,
			HttpServletResponse response,
			ModelMap model) throws Exception{
		
		/**
		 * 로그인 사용자 정보  
		 * 
		 */
		
		MemberVO loginInfo = CommonUtil.getMemberInfo();
		
		//공지사항 최근 5건 List 조회
		HashMap<String,Object> retMap = userMainService.getNoticeList();
		List<NoticeVO> noticeList = (List<NoticeVO>)retMap.get("list");
		
		model.addAttribute("noticeList", noticeList);
		
		
		List<CodeInfoVO> scoreStatus = comService.getCodeInfoListNoTitle("C04");
		GaugeItemValue gauagValue = new GaugeItemValue();
		gauagValue.setGood("100");
		for(CodeInfoVO row:scoreStatus){
			if(row.getMinr_code().equals("WAN")){
				gauagValue.setDanger(row.getCode_desc());
			}else if(row.getMinr_code().equals("GOD")){
				gauagValue.setWarning(row.getCode_desc());
			}
		}
		model.addAttribute("gauagValue", gauagValue);
		
		//테스트 
		//loginInfo.setUserid("10045632");
		
		
		
		// 전사평균
		UserMainIdxInfoVO totalAvg = userMainService.getTotalAvg();
		model.addAttribute("totalAvg", totalAvg);
		
		//사용자 , 사용자 팀, 사용자 상위 팀 보안점수 조회
		UserMainIdxInfoVO userIdxVo = userMainService.getUserIdxInfo(loginInfo.getUserid());
		
		model.addAttribute("userIdxVo", userIdxVo);
		
		
		
	 	//사용자 정책별 점수 
		HashMap<String,Object> resultMap = userMainService.getUserPolIdxInfoList(loginInfo.getUserid());
		List<UserPolIdxInfoVO> userPolIdxInfoList = (List<UserPolIdxInfoVO>)resultMap.get("list");
		model.addAttribute("userPolIdxInfoList", userPolIdxInfoList);
		
		model.addAttribute("userNm", loginInfo.getUsername());
		
		
		return "main/userMain";
		
	}
	
	
	/**
	 * 팝업
	 * @param request
	 * @param sanctno
	 * @param response
	 * @throws Exception
	 */
	@RequestMapping(value="/main/userPolIdxInfoPopup.do")
	public void sanctconfigpopup(HttpServletRequest request, String sanctno, HttpServletResponse response,UserPolIdxInfoVO userPolIdxInfo ) throws Exception {
		Gson gson = new Gson();
		
		String msg = "Error!!";
	    Boolean isOk = false; 
		
	    StringBuffer popupBody = new StringBuffer();
	    
	    /**
		 * 로그인 사용자 정보  
		 * 
		 */
		
		MemberVO loginInfo = CommonUtil.getMemberInfo();
	    
	    userPolIdxInfo.setEmp_no(loginInfo.getUserid());
	    
	    HashMap<String,Object> hMap = new HashMap<String,Object>();
	    try
		{
	    	Boolean isAuthenticated = EgovUserDetailsHelper.isAuthenticated();
			if (!isAuthenticated) {
				response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
				throw new Exception("AUTH ERROR!");
		    }
			
		
		/** 해당 정책 상세정보 조회 **/
		UserPolIdxInfoVO userPolIdxInfoVO = userMainService.getuserPolIdxInfo(userPolIdxInfo);
		
		/** 상세로그 조회 START**/
		
		Calendar cal = Calendar.getInstance();
		cal.add(Calendar.DATE, -1);
		SimpleDateFormat dtforamt = new SimpleDateFormat("YYYYMMdd");
		
    	String polcode = userPolIdxInfo.getSec_pol_id();
		String empno = loginInfo.getUserid();
		String begindate = dtforamt.format(cal.getTime());
		String mac = "";
		
		HashMap<String, String> hMap2 = new HashMap<String, String>();
		hMap2.put("polcode", polcode);
		hMap2.put("empno", empno);
		hMap2.put("begindate", begindate);
		hMap2.put("mac", mac);
		int logCnt = 0;
		
		EgovMap tblInfo = polService.getPolDetailLogTableNColumns(hMap2);
		
		hMap2.put("tblname", String.format("\"public\".\"%s\"", tblInfo.get("tblname").toString()));
		hMap2.put("columnsname", tblInfo.get("columnsname").toString());
		
		List<LinkedHashMap<String, Object>> Logs = getDataService.getPolDetailLogForDateNUser(hMap2);
		
    	
    	/** 상세로그 조회 END**/
		popupBody.append("<div id='' class='ly_type1'>");
	    popupBody.append("    <div class='popup_ly'>");
	    popupBody.append("        <div style='cursor:move;' class='popup_stt'><li><span>상세 내용 및 조치 방안</span><a style='cursor:pointer;' class='btn_dialogbox_close'><img src='/img/btn_close.png' alt='close' title='close' /></a></li></div>");
	    popupBody.append("        <div class='popup_score'>");
	    popupBody.append("        	<!-- S : graph block 사이즈 140px -->");
	    popupBody.append("            <ul class='popup_graph_block'>");
	    popupBody.append(String.format("                <li class='cell2'><div style='min-width: 200px;' class='chart' data-percent='%s'></div></li>",userPolIdxInfoVO.getScore() ));
	    popupBody.append(String.format("                <li class='cell3'>score<span>%s</span></li>",userPolIdxInfoVO.getScore() ));
	    popupBody.append("                <!-- 소명대상일때 class = calling_1 / 소명배대상일때 class = calling_2 -->");
	    if(userPolIdxInfoVO.getAppr_id() == "" || userPolIdxInfoVO.getAppr_id() == null){
	    	popupBody.append("                <li class='cell1'><span class='calling_2'>소명비대상</span></li> ");  
	    }else{
	    	popupBody.append("                <li class='cell1'><span class='calling_1'>소명요청</span></li> ");  
	    }
	    popupBody.append("            </ul>");
	    popupBody.append("            <!-- E : graph block -->");
	    popupBody.append("            <div class='popup_cnt'>");
	    popupBody.append("            	<h4><img src='/img/icon_04.png' /> 상세내용</h4>");
	    
	    if(Logs.size() >0){
	    	List<EgovMap> columnsInfo = secPolService.getPolSourceLogTableColumns(tblInfo.get("tblname").toString());
	    	popupBody.append("                <li><div class='cnt_textarea'  style='overflow: scroll;'><table border='1' class='tblInfoType4' cellpadding=0 cellspacing=0 >");
	    	logCnt = Logs.size();
	    	HashMap<?,?> log = (HashMap<?,?>)Logs.get(0);
	    	popupBody.append("<tr>");
			for(Object key:log.keySet())
			{
				popupBody.append(String.format("<th>%s</th>", ConvertColumnsName(columnsInfo, key.toString())));
			}
			popupBody.append("</tr>");
			for(HashMap<?,?> row:Logs)
			{
				popupBody.append("<tr>");
				for(Object key:row.keySet()){
					popupBody.append(String.format("<td>%s</td>", row.get(key) == null ? "" : HTMLInputFilter.htmlSpecialChars(row.get(key).toString())));
				}
				popupBody.append("</tr>");
			}
	    	popupBody.append("                </table></div></li>");
	    } else{
	    	popupBody.append("                <li><div class='cnt_textarea'  style='overflow: scroll;'></div></li>");
	    }
	    
	    
	    
	    popupBody.append("            </div>   ");        
	    popupBody.append("        </div>");
	    popupBody.append("        <div class='popup_wrap'>");
	    popupBody.append("        	<h4><img src='/img/icon_05.png' /> 조치방안</h4>");
	    popupBody.append(String.format("            <li><div id='content' class='textarea'  style='overflow: scroll;'>%s</div></li>",userPolIdxInfoVO.getDetail()));
	    popupBody.append("        </div>");
	    popupBody.append("    </div> ");         
	    popupBody.append("</div>");
	    	isOk = true;
	       
		    hMap.put("ISOK", isOk);
		    hMap.put("MSG", msg);
		    hMap.put("popup_body", popupBody.toString());
		}
		catch(Exception ex)
		{
			msg = ex.toString();
		    hMap.put("ISOK", isOk);
		    hMap.put("MSG", msg);
			
		}
		
		response.setContentType("application/json");
		response.setContentType("text/xml;charset=utf-8");
		response.setHeader("Cache-Control", "no-cache");
		response.getWriter().write(gson.toJson(hMap));
	}
	
	private String ConvertColumnsName(List<EgovMap> columnInfo, String key){
		String columnName = key;
		try
		{
			if(key.equals("sldm_empno")){
				return "사번";
			}else if(key.equals("sldm_ip")){
				return "아이피";
			}else if(key.equals("emp_nm")){
				return "성명";
			}else if(key.equals("org_nm")){
				return "조직명";
			}else if(key.equals("sldm_mac")){
				return "MAC";
			}
			
			for(EgovMap row:columnInfo){
				if(row.get("columnname").equals(key)){
					columnName = row.get("columndesc").toString().trim().equals("") ? key : row.get("columndesc").toString();
					break;
				}
			}
			
			return columnName;
		}catch(Exception e){
			return columnName;
		}
	}
	
}
