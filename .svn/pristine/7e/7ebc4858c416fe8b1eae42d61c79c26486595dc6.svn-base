<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="userMain">

	<typeAlias alias="egovMap" type="egovframework.rte.psl.dataaccess.util.EgovMap"/>
	<typeAlias alias="noticeVO" type="sdiag.board.service.NoticeVO"/>
	<typeAlias alias="userIdxInfo" type="sdiag.main.service.UserMainIdxInfoVO"/>
	<typeAlias alias="userPolIdxInfo" type="sdiag.main.service.UserPolIdxInfoVO"/>
	<typeAlias alias="searchVO" type="sdiag.man.service.SearchVO"/>
	 
	
	
	<!-- 공지사항 LIST -->
	<select id="userMain.getNoticeList" parameterClass="searchVO" resultClass="noticeVO" >
 	<![CDATA[
 		SELECT 
			N.sq_no,
  			N.n_type,
  			N.contents,
  			N.title,
  			N.read_cnt,
  			N.status_cd,
  			to_char(N.upd_date, 'YYYY-MM-DD') upd_date,
  			N.is_popup,
  			U.emp_nm upd_user
		FROM "notice_info" N
		LEFT JOIN "org_user" U ON N.upd_user=U.emp_no
		WHERE n_type='0000'
		
 	]]>
 	<isNotEmpty prepend="AND"  property="searchKeyword">
 	N.is_popup = #searchKeyword#
	</isNotEmpty>
				order by upd_date desc
 	<isNotEmpty property="sq_no">
		<isNotEqual property="sq_no" compareValue="0">
		LIMIT #sq_no#
		</isNotEqual>
	</isNotEmpty>
				
				
 	</select>
 	
 	<select id="userMain.getFaqList" resultClass="noticeVO">
 	<![CDATA[
 		SELECT 
			N.sq_no,
  			N.n_type,
  			N.contents,
  			N.title,
  			N.read_cnt,
  			N.status_cd,
  			to_char(N.upd_date, 'YYYY-MM-DD') upd_date,
  			N.is_popup,
  			U.emp_nm upd_user
		FROM "notice_info" N
		LEFT JOIN "org_user" U ON N.upd_user=U.emp_no
		WHERE n_type = '0001'
		order by upd_date desc
		LIMIT 3;
 	]]>
 	</select>
 	
 	
 	<!-- 사용자, 사용자 팀, 사용자 상위 팀 보안 점수 조회  -->
	<select id="userMain.getUserIdxInfo" resultClass="userIdxInfo" parameterClass="java.lang.String">
 	<![CDATA[
 		WITH userIdx(rgdt_date, emp_no, scor_curr, score)AS
		(
			SELECT idx_rgdt_date, emp_no, coalesce(ROUND(avg(d.scor_curr), 0), 0), coalesce(ROUND(avg(d.score), 0), 0) 
			FROM user_idx_info_day d
			WHERE d.idx_rgdt_date = to_char(current_date-1, 'YYYYMMDD')
			AND d.emp_no =#userId#
			GROUP BY d.idx_rgdt_date, d.emp_no
		)SELECT L.rgdt_date, L.emp_no, L.scor_curr, L.score,
				substr(L.rgdt_date,1,4) year_val, substr(L.rgdt_date,5,2) month_val, substr(L.rgdt_date,7,2) day_val,
				U.emp_nm, U.email,
				UORG.org_code u_org_code, UORG.org_nm u_org_nm, UORG.tot_emp u_tot_emp, UORG.avg u_avg, 
				UPORG.org_code upper_org_code, UPORG.org_nm upper_org_nm, UPORG.tot_emp upper_org_tot_emp, UPORG.avg upper_avg
		FROM userIdx L
		INNER JOIN org_user U ON U.emp_no=L.emp_no
		LEFT JOIN total_sum_info UORG ON UORG.org_code=U.org_code AND UORG.sum_rgdt_date=L.rgdt_date
		LEFT JOIN total_sum_info UPORG ON UPORG.org_code=(SELECT CASE WHEN upper_org_code = '000000' THEN '000001' ELSE  coalesce(upper_org_code, '000001') END FROM org_group WHERE org_code=U.org_code) AND UPORG.sum_rgdt_date=L.rgdt_date
		WHERE U.stat='1'
		
 	]]>
 	</select>
 	
 	
 	<!-- 사용자 정책별 점수  -->
	<select id="userMain.getUserPolIdxInfoList" resultClass="userPolIdxInfo" parameterClass="java.lang.String">
 	<![CDATA[
		SELECT 
			p.sec_pol_id, p.sec_sol_id, p.sec_pol_desc, i.idx_rgdt_date, coalesce(p.reason, '') reason, coalesce(p.sec_pol_notice_detail, '')  as detail, 
			i.emp_no,i.mac, i.pol_idx_id, i.ip, coalesce(i.appr_id, ''),
			coalesce(i.score, 100) score,
			coalesce(i.count, 0) count,
			CASE WHEN coalesce(i.score, 100) >= (SELECT code_desc::integer FROM code_info WHERE majr_code='C04' AND minr_code='GOD') THEN 'GOOD' ELSE
				CASE WHEN coalesce(i.score, 100) < (SELECT code_desc::integer FROM code_info WHERE majr_code='C04' AND minr_code='GOD') 
				      AND coalesce(i.score, 100) >= (SELECT code_desc::integer FROM code_info WHERE majr_code='C04' AND minr_code='WAN') THEN 'WARING' ELSE 'WEAK'
				END 
			END critical,
			coalesce(to_char(i.rgdt_date, 'YYYY-MM-DD'), '미탐지') rgdt_date,
			coalesce(to_char(i.org_eventdate, 'YYYY-MM-DD'), '미탐지') org_eventdate
		FROM pol_idx p
		LEFT JOIN user_idx_info i ON i.pol_idx_id=p.sec_pol_id AND i.idx_rgdt_date= to_char(current_date-1, 'YYYYMMDD') AND i.emp_no=#userId#
		WHERE p.use_indc = 'Y'
		ORDER BY p.ordr;

 	]]>
 	</select>
 	
 	<!-- 사용자 정책별 점수  -->
	<select id="userMain.getUserPolIdxInfo" resultClass="userPolIdxInfo" parameterClass="userPolIdxInfo">
 	<![CDATA[
		SELECT 
			p.sec_pol_id, p.sec_sol_id, p.sec_pol_desc, i.idx_rgdt_date, coalesce(p.reason, '') reason, coalesce(p.sec_pol_notice_detail, '')  as detail, 
			i.emp_no,i.mac, i.pol_idx_id, i.ip, coalesce(i.appr_id, ''),
			coalesce(i.score, 100) score,
			coalesce(i.count, 0) count,
			CASE WHEN coalesce(i.score, 100) >= (SELECT code_desc::integer FROM code_info WHERE majr_code='C04' AND minr_code='GOD') THEN 'GOOD' ELSE
				CASE WHEN coalesce(i.score, 100) < (SELECT code_desc::integer FROM code_info WHERE majr_code='C04' AND minr_code='GOD') 
				      AND coalesce(i.score, 100) >= (SELECT code_desc::integer FROM code_info WHERE majr_code='C04' AND minr_code='WAN') THEN 'WARING' ELSE 'WEAK'
				END 
			END critical,
			coalesce(to_char(i.rgdt_date, 'YYYY-MM-DD'), '미탐지') rgdt_date,
			coalesce(to_char(i.org_eventdate, 'YYYY-MM-DD'), '미탐지') org_eventdate
		FROM pol_idx p
		LEFT JOIN user_idx_info i ON i.pol_idx_id=p.sec_pol_id AND i.idx_rgdt_date= to_char(current_date-1, 'YYYYMMDD') AND i.emp_no=#emp_no#
		WHERE p.use_indc = 'Y'
		AND p.sec_pol_id=#sec_pol_id#

 	]]>
 	</select>
 	
 	<!-- 전사 평균  -->
	<select id="userMain.getTotalAvg" resultClass="userIdxInfo">
 	<![CDATA[
		 SELECT
			org_code,
			org_nm,
			avg score     
    	FROM
        	total_sum_info    
    	WHERE
        	org_code= '000001'    
        	AND sum_rgdt_date in (select  to_char((current_date - 1),'YYYYMMDD'));
 	]]>
 	</select>
 	
 	
 	
 	
</sqlMap>